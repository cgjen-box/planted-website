---
/**
 * VenueDetailPanelV3 - Slide-in panel showing full venue details
 * Includes hero image, all dishes with photos, and order CTA
 */
import IconsV3 from './icons/IconsV3.astro';

export interface Props {
  translations: {
    products: string;
    dishesWithPlanted: string;
    orderFrom: string;
    vegan: string;
    close: string;
  };
}

const { translations } = Astro.props;
---

<div class="v3-detail-overlay" id="v3DetailOverlay">
  <div class="v3-detail-panel" id="v3DetailPanel">
    <header class="v3-detail-header">
      <button class="v3-detail-close" id="v3DetailClose" type="button" aria-label={translations.close}>
        <IconsV3 name="close" />
      </button>
      <div class="v3-detail-title-wrap">
        <h2 class="v3-detail-venue-name" id="v3DetailName">Venue Name</h2>
        <div class="v3-detail-venue-meta" id="v3DetailMeta">
          <span id="v3DetailRating"></span>
          <span id="v3DetailLocation"></span>
        </div>
      </div>
    </header>

    <div class="v3-detail-hero" id="v3DetailHero">
      <div class="v3-detail-hero-placeholder">
        <IconsV3 name="restaurant" />
      </div>
    </div>

    <div class="v3-detail-content">
      <section class="v3-detail-section">
        <h3 class="v3-detail-section-title">{translations.products}</h3>
        <div class="v3-detail-products" id="v3DetailProducts"></div>
      </section>

      <section class="v3-detail-section">
        <h3 class="v3-detail-section-title">{translations.dishesWithPlanted}</h3>
        <div class="v3-dish-cards" id="v3DetailDishes"></div>
      </section>
    </div>

    <footer class="v3-detail-cta">
      <h4 class="v3-order-title">{translations.orderFrom}</h4>
      <div class="v3-delivery-partners" id="v3DeliveryPartners">
        <!-- Delivery partner buttons will be rendered here dynamically -->
      </div>
    </footer>
  </div>
</div>

<script>
  // Detail Panel Controller
  class V3DetailPanel {
    private overlay: HTMLElement | null;
    private panel: HTMLElement | null;
    private closeBtn: HTMLElement | null;
    private nameEl: HTMLElement | null;
    private metaEl: HTMLElement | null;
    private heroEl: HTMLElement | null;
    private productsEl: HTMLElement | null;
    private dishesEl: HTMLElement | null;
    private deliveryPartnersEl: HTMLElement | null;
    private currentVenue: any = null;

    constructor() {
      this.overlay = document.getElementById('v3DetailOverlay');
      this.panel = document.getElementById('v3DetailPanel');
      this.closeBtn = document.getElementById('v3DetailClose');
      this.nameEl = document.getElementById('v3DetailName');
      this.metaEl = document.getElementById('v3DetailMeta');
      this.heroEl = document.getElementById('v3DetailHero');
      this.productsEl = document.getElementById('v3DetailProducts');
      this.dishesEl = document.getElementById('v3DetailDishes');
      this.deliveryPartnersEl = document.getElementById('v3DeliveryPartners');

      this.init();
    }

    private init() {
      // Close button
      this.closeBtn?.addEventListener('click', () => this.hide());

      // Click outside to close
      this.overlay?.addEventListener('click', (e) => {
        if (e.target === this.overlay) this.hide();
      });

      // ESC key to close
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.overlay?.classList.contains('active')) {
          this.hide();
        }
      });

      // Listen for venue card clicks
      document.addEventListener('click', (e) => {
        const card = (e.target as HTMLElement).closest('.v3-venue-card');
        if (card) {
          const venueId = card.getAttribute('data-venue-id');
          if (venueId) {
            this.showVenueById(venueId);
          }
        }
      });
    }

    public showVenueById(venueId: string) {
      // Get venue data from the global venues array
      const venues = (window as any).__v3Venues || [];
      const venue = venues.find((v: any) => v.id === venueId);
      if (venue) {
        this.show(venue);
      }
    }

    public show(venue: any) {
      this.currentVenue = venue;

      // Update name
      if (this.nameEl) {
        this.nameEl.textContent = venue.name;
      }

      // Update meta
      if (this.metaEl) {
        const starSvg = '<svg viewBox="0 0 24 24" fill="#F7941D" style="width:14px;height:14px;vertical-align:middle;margin-right:4px"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>';
        this.metaEl.innerHTML = `
          ${venue.rating ? `<span>${starSvg} ${venue.rating.toFixed(1)}</span>` : ''}
          <span>${venue.location} · ${venue.category}</span>
        `;
      }

      // Update hero image
      if (this.heroEl) {
        if (venue.heroImage) {
          this.heroEl.innerHTML = `<img src="${venue.heroImage}" alt="${venue.name}" loading="lazy">`;
        } else {
          this.heroEl.innerHTML = `
            <div class="v3-detail-hero-placeholder">
              <svg viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
            </div>
          `;
        }
      }

      // Update products
      if (this.productsEl) {
        this.productsEl.innerHTML = venue.products.map((p: string) =>
          `<span class="v3-detail-product-tag">${p}</span>`
        ).join('');
      }

      // Update dishes with photos
      if (this.dishesEl) {
        const dishIconSvg = '<svg viewBox="0 0 24 24"><path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z"/></svg>';

        this.dishesEl.innerHTML = venue.dishes.map((dish: any) => `
          <article class="v3-dish-card">
            <div class="v3-dish-card-image">
              ${dish.image
                ? `<img src="${dish.image}" alt="${dish.name}" loading="lazy">`
                : `<div class="v3-dish-card-image-placeholder">${dishIconSvg}</div>`
              }
            </div>
            <div class="v3-dish-card-content">
              <div class="v3-dish-card-header">
                <span class="v3-dish-card-name">
                  ${dish.name}
                  ${dish.isVegan ? '<span class="v3-dish-badge">Vegan</span>' : ''}
                </span>
                <span class="v3-dish-card-price">${dish.price}</span>
              </div>
              ${dish.description ? `<p class="v3-dish-card-desc">${dish.description}</p>` : ''}
            </div>
          </article>
        `).join('');
      }

      // Update delivery partners
      if (this.deliveryPartnersEl) {
        const partners = venue.deliveryPartners || [];
        if (partners.length > 0) {
          this.deliveryPartnersEl.innerHTML = partners.map((partner: any) => {
            const iconName = partner.icon || 'external-link';
            const iconSvgs: Record<string, string> = {
              'uber-eats': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9V7h2v10zm4-4h-2V7h2v6z"/></svg>',
              'just-eat': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>',
              'lieferando': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>',
              'wolt': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
              'eat-ch': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm1-13h-2v2H9v2h2v2h2v-2h2v-2h-2V7z"/></svg>',
              'deliveroo': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>',
              'website': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>',
              'external-link': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 19H5V5h7V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>'
            };
            const iconSvg = iconSvgs[iconName] || iconSvgs['external-link'];
            return `
              <a href="${partner.url}" target="_blank" rel="noopener noreferrer" class="v3-delivery-partner-btn">
                ${iconSvg}
                <span>${partner.name}</span>
              </a>
            `;
          }).join('');
        } else {
          this.deliveryPartnersEl.innerHTML = '<p class="v3-no-delivery">Direkt im Restaurant verfügbar</p>';
        }
      }

      // Show panel
      this.overlay?.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Focus management for accessibility
      this.closeBtn?.focus();
    }

    public hide() {
      this.overlay?.classList.remove('active');
      document.body.style.overflow = '';
      this.currentVenue = null;
    }
  }

  // Initialize panel controller
  document.addEventListener('DOMContentLoaded', () => {
    (window as any).__v3DetailPanel = new V3DetailPanel();
  });

  // Also initialize on astro:page-load for client-side navigation
  document.addEventListener('astro:page-load', () => {
    if (!(window as any).__v3DetailPanel) {
      (window as any).__v3DetailPanel = new V3DetailPanel();
    }
  });
</script>
