---
import MapView from './MapView.astro';
import CarouselView from './CarouselView.astro';
import FilterPills from './FilterPills.astro';

interface Props {
  translations: {
    changeZip: string;
    restaurantsTab: string;
    deliveryTab: string;
    restaurantsSubtitle: string;
    deliveryTitle: string;
    deliverySubtitle: string;
    retailOnlineTitle: string;
    retailOnlineSubtitle: string;
    retailStoresSubtitle: string;
    plantedShop: string;
    vegan: string;
    route: string;
    buyOnline: string;
    // New translations for map/carousel/filters
    mapView?: string;
    listView?: string;
    showingVenues?: string;
    nearYou?: string;
    showAll?: string;
    of?: string;
    restaurants?: string;
    allVenues?: string;
    topRated?: string;
    newVenues?: string;
    sortBy?: string;
    distance?: string;
    rating?: string;
    price?: string;
  };
}

const { translations } = Astro.props;

// Default translations for new features
const defaultMapTranslations = {
  mapView: 'Map',
  listView: 'List',
  showingVenues: 'restaurants',
  nearYou: 'near you'
};

const defaultCarouselTranslations = {
  showAll: 'Show all',
  of: 'of',
  restaurants: 'restaurants'
};

const defaultFilterTranslations = {
  allVenues: 'All',
  topRated: 'Top Rated',
  newVenues: 'New',
  sortBy: 'Sort by',
  distance: 'Distance',
  rating: 'Rating',
  price: 'Price'
};
---

<div class="results-overlay" id="resultsView" aria-hidden="true">
  <div class="results-bg"></div>

  <!-- Scroll progress indicator -->
  <div class="scroll-progress" id="scrollProgress">
    <div class="scroll-progress-bar" id="scrollProgressBar"></div>
  </div>

  <header class="results-header">
    <button
      class="results-back"
      id="resultsBack"
      type="button"
      aria-label="Go back"
    >‚Üê</button>
    <div class="results-info">
      <div class="results-location">
        <span>üìç</span>
        <span id="resultsLocationText">Deutschland</span>
      </div>
      <div class="results-count" id="resultsCount" aria-live="polite"></div>
    </div>
    <button
      class="results-change"
      id="resultsChange"
      type="button"
    >{translations.changeZip}</button>
  </header>

  <!-- Tabs (restaurant path only) -->
  <nav class="results-tabs" id="resultsTabs" role="tablist" aria-label="Result categories">
    <button
      class="tab-btn active"
      data-tab="restaurants"
      role="tab"
      aria-selected="true"
      aria-controls="restaurantsPanel"
    >üçΩÔ∏è {translations.restaurantsTab}</button>
    <button
      class="tab-btn"
      data-tab="delivery"
      role="tab"
      aria-selected="false"
      aria-controls="deliveryPanel"
    >üõµ {translations.deliveryTab}</button>
  </nav>

  <!-- Filter Pills (shown for 7+ venues) -->
  <div class="filter-pills-wrapper" id="filterPillsWrapper" style="display: none;">
    <FilterPills translations={{
      ...defaultFilterTranslations,
      allVenues: translations.allVenues || defaultFilterTranslations.allVenues,
      vegan: translations.vegan,
      topRated: translations.topRated || defaultFilterTranslations.topRated,
      newVenues: translations.newVenues || defaultFilterTranslations.newVenues,
      sortBy: translations.sortBy || defaultFilterTranslations.sortBy,
      distance: translations.distance || defaultFilterTranslations.distance,
      rating: translations.rating || defaultFilterTranslations.rating,
      price: translations.price || defaultFilterTranslations.price
    }} />
  </div>

  <!-- Map View (shown for 16+ venues) -->
  <div class="map-view-wrapper" id="mapViewWrapper" style="display: none;">
    <MapView translations={{
      ...defaultMapTranslations,
      mapView: translations.mapView || defaultMapTranslations.mapView,
      listView: translations.listView || defaultMapTranslations.listView,
      showingVenues: translations.showingVenues || defaultMapTranslations.showingVenues,
      nearYou: translations.nearYou || defaultMapTranslations.nearYou
    }} />
  </div>

  <!-- Carousel View (shown for 16+ venues, alternative to traditional grid) -->
  <div class="carousel-view-wrapper" id="carouselViewWrapper" style="display: none;">
    <CarouselView translations={{
      ...defaultCarouselTranslations,
      showAll: translations.showAll || defaultCarouselTranslations.showAll,
      of: translations.of || defaultCarouselTranslations.of,
      restaurants: translations.restaurants || defaultCarouselTranslations.restaurants
    }} />
  </div>

  <!-- Traditional Grid View (always available, shown based on adaptive strategy) -->
  <div class="results-grid" id="resultsGrid" role="tabpanel">
    <!-- Content will be dynamically rendered -->
  </div>
</div>

<script is:inline>
(function() {
  'use strict';

  var initialized = false;

  function initResultsView() {
    if (initialized) return;

    var resultsView = document.getElementById('resultsView');
    var resultsBack = document.getElementById('resultsBack');
    var resultsChange = document.getElementById('resultsChange');
    var resultsTabs = document.getElementById('resultsTabs');

    if (!resultsView || !resultsBack || !resultsChange) return;

    initialized = true;

    // Back button
    resultsBack.addEventListener('click', function() {
      resultsView.dispatchEvent(new CustomEvent('results-back', { bubbles: true }));
    });

    // Change ZIP button
    resultsChange.addEventListener('click', function() {
      console.log('[DEBUG] resultsChange clicked');
      resultsView.dispatchEvent(new CustomEvent('results-change-zip', { bubbles: true }));
    });

    // Tab switching
    if (resultsTabs) {
      resultsTabs.addEventListener('click', function(e) {
        var target = e.target;
        var tabBtn = target.closest('.tab-btn');
        if (!tabBtn) return;

        var tab = tabBtn.dataset.tab;
        if (!tab) return;

        // Update active states
        resultsTabs.querySelectorAll('.tab-btn').forEach(function(btn) {
          btn.classList.remove('active');
          btn.setAttribute('aria-selected', 'false');
        });
        tabBtn.classList.add('active');
        tabBtn.setAttribute('aria-selected', 'true');

        // Dispatch tab change event
        resultsView.dispatchEvent(new CustomEvent('results-tab-change', {
          detail: { tab: tab },
          bubbles: true
        }));
      });
    }

    // Escape key to go back
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && resultsView.classList.contains('active')) {
        resultsView.dispatchEvent(new CustomEvent('results-back', { bubbles: true }));
      }
    });
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initResultsView);
  } else {
    initResultsView();
  }

  document.addEventListener('astro:page-load', initResultsView);
})();
</script>
